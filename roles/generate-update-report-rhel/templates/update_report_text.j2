RHEL Update Report - Text Format
==================================
Company: {{ report_company_name }}
Generated: {{ ansible_date_time.iso8601 }}
Report ID: {{ report_timestamp_formatted }}

FLEET SUMMARY
=============
Total Hosts: {{ play_hosts | length }}
Compliant Hosts: {{ play_hosts | map('extract', hostvars, 'available_updates') | map(attribute='results', default=[]) | map('length') | map('equalto', 0) | select() | list | length }}
Hosts Needing Updates: {{ play_hosts | map('extract', hostvars, 'available_updates') | map(attribute='results', default=[]) | map('length') | reject('equalto', 0) | list | length }}
Total Security Updates: {{ play_hosts | map('extract', hostvars, 'security_updates') | map(attribute='stdout_lines', default=[]) | map('length') | sum }}

HOST DETAILS
============
{% for host in play_hosts %}
  {% if hostvars[host].ansible_distribution is defined %}
    {% set host_updates = hostvars[host].available_updates.results | default([]) %}
      {% set host_security = hostvars[host].security_updates.stdout_lines | default([]) %}

        {{ host | upper }}
        {{ '-' * (host | length) }}
        Distribution: {{ hostvars[host].ansible_distribution }} {{ hostvars[host].ansible_distribution_version }}
        Package Manager: {{ hostvars[host].rhel_package_manager | default('yum') }}
        IP Address: {{ hostvars[host].ansible_default_ipv4.address | default('N/A') }}
        Status: {{ (host_updates | length == 0) | ternary(' COMPLIANT', ' UPDATES AVAILABLE') }}
        Total Updates: {{ host_updates | length }}
        Security Updates: {{ host_security | length }}
        {% if hostvars[host].rhel_subscription_status is defined %}
          Subscription: {{ hostvars[host].rhel_subscription_status.rc == 0 | ternary(' Active', ' Inactive') }}
        {% endif %}

        {% if host_updates | length > 0 %}
          Available Updates:
          {% for update in host_updates %}
          • {{ update.name }}-{{ update.version }}{% if host_security | length > 0 and update.name in (host_security | join(' ')) %} [SECURITY]{% endif %}
          {% endfor %}
          {% else %}
          No updates available - System is compliant
        {% endif %}

        {% if host_security | length > 0 %}
          Security Updates Details:
          {% for sec_update in host_security %}
            {{ sec_update }}
          {% endfor %}
        {% endif %}

      {% endif %}
    {% endfor %}

    RECOMMENDATIONS
    ===============
    {% set total_updates_needed = play_hosts | map('extract', hostvars, 'available_updates') | map(attribute='results', default=[]) | map('length') | reject('equalto', 0) | list | length %}
      {% if total_updates_needed == 0 %}
        All systems are compliant. No immediate action required.
        {% else %}
        {{ total_updates_needed }} host(s) require updates:
        • Review security updates and prioritize patching
        • Schedule maintenance windows for kernel updates
        • Test updates in development environment first
        • Consider automated patching for security updates
      {% endif %}

      REPORT METADATA
      ===============
      Generated By: {{ ansible_user | default('Ansible Automation') }}
      Ansible Controller: {{ ansible_hostname | default('localhost') }}
      Report Format: Text
      Report Location: {{ report_base_path | default('/tmp/reports') }}
