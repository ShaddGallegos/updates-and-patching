<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ report_title }} - {{ ansible_date_time.date }}</title>
<style>
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
margin: 0;
padding: 20px;
background-color: #f5f5f5;
color: #333;
}
.container {
max-width: 1200px;
margin: 0 auto;
background: white;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
overflow: hidden;
}
.header {
background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
color: white;
padding: 30px;
text-align: center;
}
.header h1 {
margin: 0;
font-size: 2.5rem;
font-weight: 300;
}
.header .subtitle {
margin: 10px 0 0 0;
font-size: 1.1rem;
opacity: 0.9;
}
.summary-cards {
display: flex;
flex-wrap: wrap;
padding: 30px;
gap: 20px;
background: #f8fafc;
border-bottom: 1px solid #e2e8f0;
}
.card {
flex: 1;
min-width: 200px;
background: white;
border-radius: 8px;
padding: 20px;
text-align: center;
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.card-value {
font-size: 2.5rem;
font-weight: bold;
margin-bottom: 5px;
}
.card-label {
color: #64748b;
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 0.5px;
}
.compliant { color: #059669; }
.updates-needed { color: #dc2626; }
.security { color: #ea580c; }
.total { color: #1e40af; }

.content {
padding: 30px;
}
.host-table {
width: 100%;
border-collapse: collapse;
margin-top: 20px;
background: white;
border-radius: 8px;
overflow: hidden;
box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.host-table th {
background: #1e40af;
color: white;
padding: 15px;
text-align: left;
font-weight: 600;
}
.host-table td {
padding: 15px;
border-bottom: 1px solid #e2e8f0;
vertical-align: top;
}
.host-table tr:hover {
background: #f1f5f9;
}
.status-badge {
display: inline-block;
padding: 4px 12px;
border-radius: 20px;
font-size: 0.8rem;
font-weight: 600;
text-transform: uppercase;
}
.status-compliant {
background: #dcfce7;
color: #166534;
}
.status-updates {
background: #fee2e2;
color: #991b1b;
}
.update-list {
max-height: 200px;
overflow-y: auto;
margin: 0;
padding: 0;
}
.update-list li {
list-style: none;
padding: 5px 0;
border-bottom: 1px solid #f1f5f9;
}
.update-list li:last-child {
border-bottom: none;
}
.security-update {
background: #fef3c7;
padding: 3px 8px;
border-radius: 4px;
font-weight: 600;
}
.footer {
background: #f8fafc;
padding: 20px 30px;
border-top: 1px solid #e2e8f0;
font-size: 0.9rem;
color: #64748b;
text-align: center;
}
.version-badge {
background: #e0e7ff;
color: #3730a3;
padding: 2px 8px;
border-radius: 4px;
font-size: 0.8rem;
font-weight: 600;
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>{{ report_title }}</h1>
<div class="subtitle">
Generated on {{ ansible_date_time.date }} at {{ ansible_date_time.time }}
<br>RHEL 7-10 Infrastructure Update Compliance
</div>
</div>

<div class="summary-cards">
<div class="card">
<div class="card-value total">{{ play_hosts | length }}</div>
<div class="card-label">Total Hosts</div>
</div>
<div class="card">
<div class="card-value compliant">{{ play_hosts | map('extract', hostvars, 'available_updates') | map(attribute='results', default=[]) | map('length') | map('equalto', 0) | select() | list | length }}</div>
<div class="card-label">Compliant</div>
</div>
<div class="card">
<div class="card-value updates-needed">{{ play_hosts | map('extract', hostvars, 'available_updates') | map(attribute='results', default=[]) | map('length') | reject('equalto', 0) | list | length }}</div>
<div class="card-label">Need Updates</div>
</div>
<div class="card">
<div class="card-value security">{{ play_hosts | map('extract', hostvars, 'security_updates') | map(attribute='stdout_lines', default=[]) | map('length') | sum }}</div>
<div class="card-label">Security Updates</div>
</div>
</div>

<div class="content">
<h2>Host Update Status</h2>
<table class="host-table">
<thead>
<tr>
<th>Hostname</th>
<th>RHEL Version</th>
<th>Package Manager</th>
<th>Status</th>
<th>Available Updates</th>
<th>Security Updates</th>
</tr>
</thead>
<tbody>
{% for host in play_hosts %}
  {% if hostvars[host].ansible_distribution is defined %}
    {% set host_updates = hostvars[host].available_updates.results | default([]) %}
      {% set host_security = hostvars[host].security_updates.stdout_lines | default([]) %}
        <tr>
        <td>
        <strong>{{ host }}</strong>
        <br><small>{{ hostvars[host].ansible_default_ipv4.address | default('N/A') }}</small>
        </td>
        <td>
        <span class="version-badge">
        {{ hostvars[host].ansible_distribution }} {{ hostvars[host].ansible_distribution_version }}
        </span>
        </td>
        <td>{{ hostvars[host].rhel_package_manager | default('yum') }}</td>
        <td>
        {% if host_updates | length == 0 %}
          <span class="status-badge status-compliant"> Compliant</span>
          {% else %}
          <span class="status-badge status-updates"> {{ host_updates | length }} Updates</span>
        {% endif %}
        </td>
        <td>
        {% if host_updates | length > 0 %}
          <ul class="update-list">
          {% for update in host_updates %}
            <li>
            {{ update.name }}-{{ update.version }}
            {% if host_security | length > 0 and update.name in (host_security | join(' ')) %}
              <span class="security-update"> Security</span>
            {% endif %}
            </li>
          {% endfor %}
          </ul>
          {% else %}
          <span class="compliant">No updates available</span>
        {% endif %}
        </td>
        <td>
        {% if host_security | length > 0 %}
          <strong class="security">{{ host_security | length }} security updates</strong>
          {% else %}
          <span class="compliant">No security updates</span>
        {% endif %}
        </td>
        </tr>
      {% endif %}
    {% endfor %}
    </tbody>
    </table>

    {% if rhel_subscription_status is defined %}
      <h3>Subscription Status</h3>
      <div style="background: #f1f5f9; padding: 15px; border-radius: 6px; margin: 20px 0;">
      {% for host in play_hosts %}
        {% if hostvars[host].rhel_subscription_status is defined %}
          <p><strong>{{ host }}:</strong>
          {% if hostvars[host].rhel_subscription_status.rc == 0 %}
            <span class="compliant"> Active Subscription</span>
            {% else %}
            <span class="updates-needed"> Inactive/Unknown</span>
          {% endif %}
          </p>
        {% endif %}
      {% endfor %}
      </div>
    {% endif %}
    </div>

    <div class="footer">
    Generated by Ansible on {{ ansible_date_time.iso8601 }} |
    {{ report_company_name }} |
    Report ID: {{ report_timestamp_formatted }}
    </div>
    </div>
    </body>
    </html>